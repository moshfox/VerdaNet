<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Verd@Net ‚Äî Chat</title>
<link rel="icon" href="icon.ico" type="image/x-icon">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root { color-scheme: dark; }
  html, body { height: 100%; }
  body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; transition: background 300ms ease; }
  .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.08); }
  .badge { font-size: 10px; padding: 2px 6px; border-radius: 9999px; }
  .bubble { border: 1px solid rgba(255,255,255,0.08); }
  .img-msg { max-height: 360px; border-radius: 0.8rem; }
  .brand-vn { width: 40px; height: 40px; border-radius: 0.75rem; background:#2563eb; display:grid; place-items:center; color:white; font-weight:800; letter-spacing:.5px; box-shadow:0 10px 20px rgba(37,99,235,.25); }
  .brand-vn.small { width:36px; height:36px; border-radius: .75rem; font-size: .8rem; }
  /* TOP ‚Äúmuseo‚Äù animado */
  .top-epic {
    position: relative;
    background: linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.03));
    border: 1px solid rgba(250, 204, 21, 0.35);
    box-shadow: 0 0 0 1px rgba(250,204,21,0.12), 0 10px 30px rgba(0,0,0,0.35), inset 0 0 40px rgba(250,204,21,0.06);
  }
  .top-epic::before {
    content:""; position:absolute; inset:-1px; border-radius:1rem;
    background: conic-gradient(from 0deg, rgba(250,204,21,.22), transparent 40%, transparent 60%, rgba(250,204,21,.22));
    filter: blur(6px); z-index:-1; opacity:.6; animation:spin 8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .ribbon {
    position:absolute; top:-10px; left:50%; transform:translateX(-50%);
    padding:4px 10px; font-size:11px; font-weight:700;
    background: radial-gradient(circle at 30% 30%, rgba(250,204,21,.35), rgba(250,204,21,.08));
    border:1px solid rgba(250,204,21,.35); border-radius:9999px; color:#fde68a; backdrop-filter: blur(4px);
    box-shadow: 0 2px 12px rgba(250,204,21,.25);
  }
  /* separador d√≠a (fix: no tapa mensajes) */
  .day-sep { position: relative; margin: 18px 0 8px 0; z-index: 0; }

  /* Bot√≥n juegos llamativo */
  .btn-games {
    position: relative; overflow: hidden;
    background: linear-gradient(135deg,#7c3aed,#ec4899);
    color:#fff; box-shadow: 0 8px 24px rgba(236,72,153,.35);
    transition: transform .15s ease, box-shadow .2s ease;
  }
  .btn-games:hover { transform: translateY(-1px); box-shadow: 0 12px 28px rgba(236,72,153,.5); }
  .btn-games::after {
    content:""; position:absolute; inset:-1px; background: conic-gradient(from 0deg, transparent, rgba(255,255,255,.35), transparent 30%);
    filter: blur(6px); opacity:.45; animation:spin 2.8s linear infinite;
  }
</style>
</head>
<body class="min-h-full bg-gradient-to-br from-zinc-950 via-zinc-900 to-black text-zinc-100 selection:bg-indigo-600/30">

<!-- Auth (login abierto, sin lista blanca) -->
<div id="authView" class="min-h-screen grid place-items-center p-6">
  <div class="glass rounded-2xl p-6 w-full max-w-md">
    <div class="flex items-center gap-3 mb-4">
      <div class="brand-vn">VN</div>
      <div>
        <h1 class="text-xl font-bold">Verd@Net</h1>
        <p class="text-sm text-zinc-400">Accede a tu cuenta</p>
      </div>
    </div>
    <div class="space-y-3">
      <input id="email" type="email" placeholder="Email" class="w-full px-4 py-3 rounded-xl bg-zinc-900 border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-600" />
      <input id="password" type="password" placeholder="Contrase√±a" class="w-full px-4 py-3 rounded-xl bg-zinc-900 border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-600" />
      <div class="flex gap-3">
        <button id="loginBtn" class="px-3 py-2 rounded-xl text-sm bg-indigo-600 hover:bg-indigo-500 transition">Iniciar sesi√≥n</button>
        <button id="registerBtn" class="px-3 py-2 rounded-xl text-sm hover:bg-white/10 transition">Registrarme</button>
      </div>
      <div id="authMsg" class="text-sm text-rose-400 min-h-[1.5rem]"></div>
    </div>
  </div>
</div>

<!-- App -->
<div id="appView" class="hidden h-screen">
  <div class="h-full grid grid-cols-[280px_1fr]">
    <!-- Sidebar -->
    <aside class="glass p-4 border-r border-white/10">
      <div class="flex items-center gap-3 mb-4">
        <div class="brand-vn">VN</div>
        <div>
          <div class="font-semibold leading-tight">Verd@Net</div>
          <div class="text-xs text-zinc-400">Mensajes caducan en 48h</div>
        </div>
      </div>

      <div id="meCard" class="glass rounded-xl p-3 mb-4 flex items-center gap-3">
        <div id="meAvatar" class="h-9 w-9 rounded-full bg-zinc-800 grid place-items-center font-semibold"></div>
        <div class="flex-1">
          <div class="text-sm font-medium flex items-center gap-1" id="meName"></div>
          <div class="text-xs text-zinc-400" id="meEmail"></div>
        </div>
        <span id="meAdmin" class="hidden badge bg-amber-500/20 text-amber-300 border border-amber-500/30">ADMIN</span>
      </div>

      <nav class="text-sm">
        <div class="mb-2 px-2 text-xs uppercase tracking-wide text-zinc-400">Canales</div>
        <ul id="channelList" class="space-y-1"></ul>
        <div class="mt-4 mb-2 px-2 text-xs uppercase tracking-wide text-zinc-400">Mensajes privados</div>
        <ul id="dmList" class="space-y-1"></ul>
      </nav>

      <div class="mt-6 flex gap-2">
        <button id="signOutBtn" class="px-3 py-2 rounded-xl text-sm hover:bg-white/10 transition flex-1">Salir</button>
        <button id="clearChatBtn" class="px-3 py-2 rounded-xl text-sm hover:bg-white/10 transition hidden">Borrar chat</button>
      </div>
    </aside>

    <!-- Chat -->
    <main class="relative">
      <header class="glass sticky top-0 z-10 px-6 py-4 flex items-center justify-between border-b border-white/10">
        <div>
          <div id="chatTitle" class="text-lg font-semibold">Main</div>
          <div id="chatSub" class="text-xs text-zinc-400">Chat general</div>
        </div>
        <div class="flex items-center gap-2">
          <div id="topHint" class="text-xs text-emerald-300/90 hidden">TOP: solo lectura (admin puede borrar)</div>
          <button id="inviteGamesBtn" class="hidden px-3 py-2 rounded-xl text-sm btn-games">üéÆ Invitar a juego</button>
        </div>
      </header>

      <section id="messages" class="h-[calc(100vh-216px)] overflow-y-auto p-6 space-y-4 max-w-3xl mx-auto"></section>

      <footer id="composer" class="glass absolute bottom-0 left-0 right-0 p-4 border-t border-white/10">
        <div class="max-w-3xl mx-auto">
          <div class="flex items-end gap-3">
            <textarea id="msgInput" rows="1" placeholder="Escribe un mensaje‚Ä¶" class="flex-1 resize-none px-4 py-3 rounded-2xl bg-zinc-900 border border-white/10 focus:outline-none focus:ring-2 focus:ring-indigo-600"></textarea>
            <input id="fileInput" type="file" accept="image/*" class="hidden" />
            <button id="imgBtn" class="px-3 py-2 rounded-xl text-sm hover:bg-white/10 transition" title="A√±adir imagen">üñºÔ∏è</button>
            <button id="sendBtn" class="px-3 py-2 rounded-xl text-sm bg-indigo-600 hover:bg-indigo-500 transition">Enviar</button>
          </div>
          <div id="sendMsg" class="text-xs text-zinc-400 mt-2 min-h-[1rem]"></div>
        </div>
      </footer>
    </main>
  </div>
</div>

<!-- Modal elegir juego -->
<div id="inviteModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="relative z-10 h-full grid place-items-center p-6">
    <div class="glass rounded-2xl max-w-sm w-full p-5 border border-white/10">
      <h3 class="text-lg font-semibold mb-3">Enviar invitaci√≥n a juego</h3>
      <p class="text-sm text-zinc-300 mb-4">Elige un juego para enviar al chat:</p>
      <div class="grid grid-cols-2 gap-2">
        <button data-game="mafia" class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500">Mafia</button>
        <button data-game="lambo" class="px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black">Lamborghini</button>
      </div>
      <button id="inviteClose" class="mt-4 w-full px-3 py-2 rounded-xl hover:bg-white/10">Cancelar</button>
    </div>
  </div>
</div>

<!-- Modal VerdaNet v1.0 (estilo exacto del ejemplo) -->
<div id="verdanetModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/60"></div>
  <div class="relative z-10 h-full grid place-items-center p-6">
    <div class="glass rounded-2xl max-w-xl w-full p-6 border border-white/10">
      <div class="flex items-center gap-3 mb-4">
        <div class="brand-vn small">VN</div>
        <div>
          <h2 class="text-xl font-bold">Verd@Net <span class="text-emerald-300">v1.0</span></h2>
          <p class="text-sm text-zinc-400">Chat privado con autodestrucci√≥n de mensajes</p>
        </div>
      </div>
      <div class="rounded-xl overflow-hidden border border-white/10 mb-4">
        <svg viewBox="0 0 600 180" class="w-full h-auto">
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#10b981"/><stop offset="100%" stop-color="#0ea5e9"/>
            </linearGradient>
            <linearGradient id="g2" x1="0" y1="0" x2="1" y2="0">
              <stop offset="0%" stop-color="rgba(255,255,255,0.15)"/><stop offset="100%" stop-color="rgba(255,255,255,0.02)"/>
            </linearGradient>
          </defs>
          <rect x="0" y="0" width="600" height="180" fill="#0b0b0c"/>
          <g opacity="0.55"><circle cx="90" cy="40" r="60" fill="url(#g1)"/><circle cx="520" cy="150" r="80" fill="url(#g1)"/></g>
          <rect x="0" y="0" width="600" height="180" fill="url(#g2)"/>
          <text x="50%" y="54%" text-anchor="middle" fill="#e5e7eb" font-size="34" font-weight="700">Verd@Net 1.0</text>
          <text x="50%" y="73%" text-anchor="middle" fill="#9ca3af" font-size="16">Privado, limpio y que se borra solo en 48h</text>
        </svg>
      </div>
      <ul class="text-sm text-zinc-300 space-y-1 mb-4">
        <li>‚Ä¢ <b>Main</b> y <b>Privados</b> (1 a 1) con caducidad de 48h.</li>
        <li>‚Ä¢ <b>TOP</b> solo lectura; el admin fija y puede borrar.</li>
        <li>‚Ä¢ Admin: <b>Hodely</b>. Puede borrar, limpiar y fijar a TOP.</li>
      </ul>
      <div class="flex items-center justify-between gap-3">
        <label class="text-xs text-zinc-400 flex items-center gap-2">
          <input id="vdnDontShow" type="checkbox" class="accent-emerald-500"> No volver a mostrar
        </label>
        <button id="vdnCloseBtn" class="px-3 py-2 rounded-xl text-sm hover:bg-white/10 transition">Entendido</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // ========= Firebase =========
  const firebaseConfig = {
    apiKey: "AIzaSyCkNI9EEw_4Rf8f4IqygydRTbHSHBAYnKs",
    authDomain: "klex-28ea5.firebaseapp.com",
    databaseURL: "https://klex-28ea5-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "klex-28ea5",
    storageBucket: "klex-28ea5.appspot.com",
    messagingSenderId: "794750673743",
    appId: "1:794750673743:web:8b38291a417089e643db3a",
    measurementId: "G-DQ6E8NBVGR"
  };
  const ADMIN_EMAIL = 'hodelyproductions@gmail.com';

  // Nombres bonitos para DMs (no restringe login)
  const FRIENDS = {
  'hodelyproductions@gmail.com': 'Hodely',
  'llopez@jverdaguer.com': 'Logan',
  'harjona@jverdaguer.com': 'Hugo',
  'hgil@jverdaguer.com': 'Hodei',

  // TEST
  'logan-test@jverdaguer.com': 'Logan (test)',
  'hugo-test@jverdaguer.com': 'Hugo (test)',
  'hodely-test@jverdaguer.com': 'Hodely (test)',
};

  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import { getFirestore, collection, addDoc, doc, getDoc, onSnapshot, query, orderBy, limit, Timestamp, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const $ = (id)=>document.getElementById(id);
  const me = { avatar: $('meAvatar'), name:$('meName'), email:$('meEmail'), admin:$('meAdmin') };
  const ui = {
    authView: $('authView'), appView:$('appView'),
    email:$('email'), password:$('password'),
    loginBtn:$('loginBtn'), registerBtn:$('registerBtn'), authMsg:$('authMsg'),
    messages:$('messages'), msgInput:$('msgInput'), fileInput:$('fileInput'),
    imgBtn:$('imgBtn'), sendBtn:$('sendBtn'), sendMsg:$('sendMsg'),
    clearChatBtn:$('clearChatBtn'), signOutBtn:$('signOutBtn'),
    channelList:$('channelList'), dmList:$('dmList'),
    chatTitle:$('chatTitle'), chatSub:$('chatSub'), topHint:$('topHint'),
    composer:document.getElementById('composer'),
    inviteGamesBtn:$('inviteGamesBtn'),
    inviteModal:document.getElementById('inviteModal'),
    inviteClose:$('inviteClose'),
    verdanetModal:document.getElementById('verdanetModal'),
    vdnDontShow:document.getElementById('vdnDontShow'),
    vdnCloseBtn:document.getElementById('vdnCloseBtn'),
  };

  let CURRENT_USER=null, CURRENT_CHAT={ id:'main', type:'channel', title:'Main', readOnly:false }, UNSUB=null;

  const isAdmin = (e)=> e && e.toLowerCase()===ADMIN_EMAIL;
  const avatarFor = (name)=> (name?.[0]||'?').toUpperCase();
  const humanTime = (ts)=> { const d=ts?.toDate?ts.toDate():new Date(ts); return d.toLocaleString('es-ES',{hour12:false}); };
  function humanDay(ts){
    const d=ts?.toDate?ts.toDate():new Date(ts);
    const t=new Date(), y=new Date(); y.setDate(t.getDate()-1);
    if(d.toDateString()===t.toDateString()) return 'Hoy';
    if(d.toDateString()===y.toDateString()) return 'Ayer';
    return d.toLocaleDateString('es-ES',{weekday:'long',day:'2-digit',month:'short'});
  }
  function timeLeft(ts){ if(!ts?.toMillis) return ''; const ms=ts.toMillis()-Date.now(); if(ms<=0) return 'expirado'; const h=Math.floor(ms/3.6e6), m=Math.floor((ms%3.6e6)/6e4); return h>0?`${h}h ${m}m`:`${m}m`; }
  const escapeHtml = (t)=> t?.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')||'';
  const dmId = (a,b)=> { const [x,y]=[a.toLowerCase(), b.toLowerCase()].sort(); return `dm_${x}_${y}`; };

  // Auth (abierto)
  ui.loginBtn.onclick = async ()=>{
    try{ await signInWithEmailAndPassword(auth, ui.email.value.trim(), ui.password.value); }
    catch(e){ ui.authMsg.textContent=e.message; }
  };
  ui.registerBtn.onclick = async ()=>{
    try{ const {user}=await createUserWithEmailAndPassword(auth, ui.email.value.trim(), ui.password.value);
      await updateProfile(user,{displayName:user.email.split('@')[0]});
    } catch(e){ ui.authMsg.textContent=e.message; }
  };
  ui.signOutBtn.onclick = ()=>signOut(auth);

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      CURRENT_USER=user;
      ui.authMsg.textContent='';
      ui.authView.classList.add('hidden'); ui.appView.classList.remove('hidden');
      me.avatar.textContent=avatarFor(user.displayName||'U');
      me.name.textContent=user.displayName||'Usuario'; me.email.textContent=user.email;
      me.admin.classList.toggle('hidden', !isAdmin(user.email));
      ui.inviteGamesBtn.classList.toggle('hidden', !isAdmin(user.email));
      buildNav(user);
      openChat('main','channel');
      showVerdaNetModalIfNeeded();
    } else {
      CURRENT_USER=null;
      ui.appView.classList.add('hidden'); ui.authView.classList.remove('hidden');
    }
  });

  // NAV
  function buildNav(user){
    ui.channelList.innerHTML = '';
    [
      { id:'top',  label:'TOP (solo lectura)', type:'top', icon:'üìå' },
      { id:'main', label:'Main',               type:'channel', icon:'üí¨' },
    ].forEach(it=>{
      const li = document.createElement('li');
      li.innerHTML = `<button class="w-full text-left px-3 py-2 rounded-xl hover:bg-white/10 flex items-center gap-2"><span>${it.icon}</span><span>${it.label}</span></button>`;
      li.querySelector('button').onclick = ()=> openChat(it.id, it.type);
      ui.channelList.appendChild(li);
    });

    ui.dmList.innerHTML = '';
    const my = user.email.toLowerCase();
    Object.entries(FRIENDS).forEach(([email, name])=>{
      if(email.toLowerCase()===my) return;
      const id = dmId(my,email);
      const li = document.createElement('li');
      li.innerHTML = `<button class="w-full text-left px-3 py-2 rounded-xl hover:bg-white/10 flex items-center gap-2">
        <span>üë§</span><span>${name}</span></button>`;
      li.querySelector('button').onclick = ()=> openChat(id,'dm',name);
      ui.dmList.appendChild(li);
    });
  }

  // Abrir chat
  async function openChat(id, type, dmName){
    if(UNSUB){ UNSUB(); UNSUB=null; }
    CURRENT_CHAT = { id, type, title: type==='top'?'TOP':(type==='dm'? (dmName||'Privado') : 'Main'), readOnly: type==='top' };
    ui.chatTitle.textContent = CURRENT_CHAT.title;
    ui.chatSub.textContent = type==='top' ? 'Mensajes destacados por admin. No se borran.' :
                             type==='dm' ? 'Chat privado 1 a 1 (se borra en 48h)' :
                                           'Chat general (se borra en 48h)';
    ui.topHint.classList.toggle('hidden', type!=='top');
    ui.composer.classList.toggle('hidden', CURRENT_CHAT.readOnly);
    ui.clearChatBtn.classList.toggle('hidden', !(isAdmin(CURRENT_USER?.email) && type!=='top'));
    setBackgroundForChat(id, type);

    const collRef = type==='top' ? collection(db,'top') : collection(db,'chats', id, 'messages');
    const qRef = query(collRef, orderBy('createdAt','asc'), limit(400));

    ui.messages.innerHTML='';
    let lastDay = null;
    UNSUB = onSnapshot(qRef, (snap)=>{
      ui.messages.innerHTML=''; lastDay=null;
      snap.forEach(d=>{
        const m={ id:d.id, ...d.data() };
        if (type!=='top' && m.expiresAt && m.expiresAt.toMillis() < Date.now()) return;
        const day=humanDay(m.createdAt);
        if(day!==lastDay){ lastDay=day; renderDaySep(day); }
        renderMessage(m);
      });
      ui.messages.scrollTop = ui.messages.scrollHeight;
    });
  }

  function renderDaySep(text){
    const div=document.createElement('div'); div.className='day-sep';
    div.innerHTML=`<div class="flex items-center gap-3">
      <div class="flex-1 h-px bg-white/10"></div>
      <div class="text-xs text-zinc-400 px-3 py-1 rounded-full bg-white/5 border border-white/10">${text}</div>
      <div class="flex-1 h-px bg-white/10"></div>
    </div>`;
    ui.messages.appendChild(div);
  }

  function renderMessage(m){
    const mine = m.senderEmail?.toLowerCase()===CURRENT_USER?.email?.toLowerCase();
    const isTop = CURRENT_CHAT.type==='top';
    const wrap=document.createElement('div');

    if (isTop) {
      // TOP animado
      wrap.className = 'msg flex justify-center';
      const name = m.senderName || m.senderEmail || '‚Äî';
      const adminBadge = m.senderEmail && isAdmin(m.senderEmail) ? '<span class="badge bg-amber-500/20 text-amber-300 border border-amber-500/30 ml-2">ADMIN</span>' : '';
      wrap.innerHTML = `
        <div class="w-full">
          <div class="flex justify-center mb-2"><span class="badge bg-white/10 border border-white/15">üìÖ ${humanTime(m.createdAt)}</span></div>
          <div class="top-epic rounded-2xl p-5 mx-auto max-w-3xl relative">
            <div class="ribbon">üìå Fijado por Admin</div>
            <div class="flex items-center gap-3 mb-3">
              <div class="h-9 w-9 rounded-full bg-zinc-800 grid place-items-center font-semibold">${avatarFor(name)}</div>
              <div class="text-xs text-zinc-400">${name} ${adminBadge}</div>
            </div>
            ${m.text ? `<div class="whitespace-pre-wrap text-[15px] leading-relaxed">${escapeHtml(m.text)}</div>` : ''}
            ${m.imageURL ? `<img src="${m.imageURL}" alt="imagen" class="img-msg mt-3 border border-amber-200/20 w-full object-contain"/>` : ''}
            ${isAdmin(CURRENT_USER?.email) ? `<div class="mt-3 flex gap-2 text-xs text-zinc-300 justify-end">
              <button class="px-3 py-2 rounded-xl hover:bg-white/10 transition" data-action="delTop">üóë Quitar de TOP</button>
            </div>` : ''}
          </div>
        </div>`;
      if (isAdmin(CURRENT_USER?.email)){
        wrap.querySelector('[data-action="delTop"]')?.addEventListener('click', () => deleteTopMessage(m));
      }
    } else {
      wrap.className = `msg flex gap-3 ${mine? 'justify-end' : ''}`;
      const name = m.senderName || m.senderEmail || '‚Äî';
      const adminBadge = m.senderEmail && isAdmin(m.senderEmail) ? '<span class="badge bg-amber-500/20 text-amber-300 border border-amber-500/30 ml-2">ADMIN</span>' : '';
      const left = `<div class="h-9 w-9 rounded-full bg-zinc-800 grid place-items-center font-semibold">${avatarFor(name)}</div>`;
      const meta = `<div class="text-xs text-zinc-400 mb-1">${name} ${adminBadge} ¬∑ ${humanTime(m.createdAt)}</div>`;
      const bubbleClass = mine ? 'bg-gradient-to-br from-indigo-600 to-indigo-500 border-indigo-500 text-white shadow-xl' : 'glass';

      // Invitaciones con elecci√≥n
      let custom = '';
      if (m.type==='invite' && m.game==='mafia') {
        custom = `<div class="mt-2"><a href="mafia.html" class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-sm">Entrar a Mafia</a></div>`;
      } else if (m.type==='invite' && m.game==='lambo') {
        custom = `<div class="mt-2"><a href="lambo.html" class="px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black text-sm">Entrar a Lamborghini</a></div>`;
      }

      wrap.innerHTML = `
        <div class="flex items-start gap-3 max-w-[80%] ${mine? 'flex-row-reverse' : ''}">
          ${left}
          <div>
            ${meta}
            <div class="bubble rounded-2xl p-3 ${bubbleClass}">
              ${m.text ? `<div class="whitespace-pre-wrap">${escapeHtml(m.text)}</div>` : ''}
              ${m.imageURL ? `<img src="${m.imageURL}" alt="imagen" class="img-msg mt-2 border border-white/10"/>` : ''}
              ${custom}
            </div>
            <div class="mt-1 flex items-center gap-2">
              ${m.expiresAt ? `<span class="badge bg-white/10 border border-white/15">‚è≥ caduca en <span data-exp="${m.expiresAt.toMillis()}">${timeLeft(m.expiresAt)}</span></span>` : ''}
              ${isAdmin(CURRENT_USER?.email) ? `
                <button class="px-2 py-1 rounded-lg hover:bg-white/10 transition text-xs" data-action="pin">üìå Pin a TOP</button>
                <button class="px-2 py-1 rounded-lg hover:bg-white/10 transition text-xs" data-action="del">üóë Borrar</button>` : ''}
            </div>
          </div>
        </div>`;
      if (isAdmin(CURRENT_USER?.email)){
        wrap.querySelector('[data-action="pin"]')?.addEventListener('click', () => pinToTop(m));
        wrap.querySelector('[data-action="del"]')?.addEventListener('click', () => deleteMessage(m));
      }
    }
    ui.messages.appendChild(wrap);
  }

  // Env√≠o
  $('imgBtn').onclick = ()=> $('fileInput').click();
  $('sendBtn').onclick = sendMessage;
  $('msgInput').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    setTimeout(()=> { const t=$('msgInput'); t.style.height='auto'; t.style.height=Math.min(t.scrollHeight, 180)+'px'; }, 0);
  });

  async function sendMessage(){
    if (CURRENT_CHAT.readOnly) return;
    const text = ui.msgInput.value.trim();
    const file = ui.fileInput.files?.[0] || null;
    if (!text && !file) return;
    ui.sendBtn.disabled = true; ui.sendMsg.textContent = 'Enviando‚Ä¶';
    try {
      let imageURL = null, imagePath = null;
      if (file) {
        const path = `uploads/${CURRENT_CHAT.id}/${Date.now()}_${CURRENT_USER.uid}_${file.name}`;
        const ref = sRef(storage, path);
        const data = await file.arrayBuffer();
        await uploadBytes(ref, new Blob([data], { type: file.type }));
        imageURL = await getDownloadURL(ref); imagePath = path;
      }
      const coll = CURRENT_CHAT.type==='top' ? collection(db,'top') : collection(db,'chats', CURRENT_CHAT.id, 'messages');
      const created = Timestamp.now();
      const expires = Timestamp.fromMillis(Date.now() + 48*60*60*1000);
      await addDoc(coll, {
        chatId: CURRENT_CHAT.id,
        text: text || null,
        imageURL: imageURL || null,
        imagePath: imagePath || null,
        senderUid: CURRENT_USER.uid,
        senderEmail: CURRENT_USER.email,
        senderName: CURRENT_USER.displayName || 'Usuario',
        createdAt: created,
        ...(CURRENT_CHAT.type!=='top' ? { expiresAt: expires } : {})
      });
      ui.msgInput.value=''; ui.fileInput.value=''; ui.msgInput.style.height='auto';
      ui.sendMsg.textContent='‚úîÔ∏è Enviado'; setTimeout(()=> ui.sendMsg.textContent='', 1200);
    } catch(e){ console.error(e); ui.sendMsg.textContent='Error: '+e.message; }
    finally { ui.sendBtn.disabled=false; }
  }

  // ADMIN: abrir modal de invitaci√≥n
  ui.inviteGamesBtn.onclick = ()=>{ if(!isAdmin(CURRENT_USER?.email)) return; ui.inviteModal.classList.remove('hidden'); };
  ui.inviteClose.onclick = ()=> ui.inviteModal.classList.add('hidden');
  ui.inviteModal.querySelectorAll('[data-game]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const game = btn.getAttribute('data-game'); // 'mafia' | 'lambo'
      const coll=collection(db,'chats','main','messages');
      await addDoc(coll,{
        type:'invite', game,
        text: game==='mafia' ? 'üì£ Invitaci√≥n: el admin ha abierto Mafia.' : 'üì£ Invitaci√≥n: el admin ha abierto Lamborghini.',
        senderUid:CURRENT_USER.uid, senderEmail:CURRENT_USER.email, senderName:CURRENT_USER.displayName||'Admin',
        createdAt:Timestamp.now(),
        expiresAt:Timestamp.fromMillis(Date.now()+48*60*60*1000)
      });
      ui.inviteModal.classList.add('hidden');
    });
  });

  // Admin: TOP pin/borrar y borrar mensajes
  async function pinToTop(m){
    if(!isAdmin(CURRENT_USER?.email)) return;
    try{
      await addDoc(collection(db,'top'), {
        fromChat: CURRENT_CHAT.id, originalMessageId: m.id, text: m.text || null,
        imageURL: m.imageURL || null, senderName: m.senderName, senderEmail: m.senderEmail, createdAt: Timestamp.now()
      });
    }catch(e){ alert('No se pudo pinear: '+e.message); }
  }
  async function deleteMessage(m){
    if(!isAdmin(CURRENT_USER?.email)) return;
    try{
      await deleteDoc(doc(db,'chats', CURRENT_CHAT.id, 'messages', m.id));
      if (m.imagePath) { try { await deleteObject(sRef(storage, m.imagePath)); } catch {} }
    }catch(e){ alert('No se pudo borrar: '+e.message); }
  }
  async function deleteTopMessage(m){
    if(!isAdmin(CURRENT_USER?.email)) return;
    try{ await deleteDoc(doc(db,'top', m.id)); }
    catch(e){ alert('No se pudo borrar de TOP: '+e.message); }
  }
  ui.clearChatBtn.onclick = async ()=>{
    if(!isAdmin(CURRENT_USER?.email)) return;
    if(!confirm('¬øBorrar TODOS los mensajes de este chat?')) return;
    const coll=collection(db,'chats', CURRENT_CHAT.id, 'messages');
    let snap=await getDocs(query(coll, orderBy('createdAt'), limit(200)));
    let total=0;
    while(!snap.empty){
      const batch=writeBatch(db);
      for(const d of snap.docs){
        const m=d.data(); batch.delete(d.ref);
        if(m.imagePath){ try{ await deleteObject(sRef(storage, m.imagePath)); }catch{} }
      }
      await batch.commit(); total+=snap.size;
      snap=await getDocs(query(coll, orderBy('createdAt'), limit(200)));
    }
    alert(`Borrado: ${total} mensajes`);
  };

  // Fondo por chat
  function hashCode(str){ let h=0; for (let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return Math.abs(h); }
  function setBackgroundForChat(id,type){
    const hue = hashCode(`${type}:${id}`)%360;
    const c1 = `hsl(${hue}, 10%, 10%)`, c2 = `hsl(${(hue+14)%360}, 10%, 7%)`;
    document.body.style.background = `linear-gradient(135deg, ${c1}, ${c2})`;
  }

  // Caducidad UI
  setInterval(()=> {
    document.querySelectorAll('[data-exp]').forEach(el=>{
      const ms = parseInt(el.getAttribute('data-exp'),10) - Date.now();
      const h = Math.max(0, Math.floor(ms/3.6e6));
      const m = Math.max(0, Math.floor((ms%3.6e6)/6e4));
      el.textContent = ms<=0 ? 'expirado' : (h>0? `${h}h ${m}m` : `${m}m`);
    });
  }, 60000);

  // Modal versi√≥n v1.0 (estilo ejemplo) ‚Äî solo primera vez
  function showVerdaNetModalIfNeeded(){
    const key = 'verdanet_seen_1_0';
    const modal = ui.verdanetModal;
    if (!modal) return;
    const show = () => modal.classList.remove('hidden');
    const hide = () => modal.classList.add('hidden');
    const close = () => { if (ui.vdnDontShow?.checked) localStorage.setItem(key,'true'); hide(); };
    if (!localStorage.getItem(key)) show();
    ui.vdnCloseBtn?.addEventListener('click', close, { once:true });
  }
</script>
</body>
</html>

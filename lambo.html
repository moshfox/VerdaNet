<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lamborghini ‚Äî Verd@Net</title>
<link rel="icon" href="icon.ico" type="image/x-icon">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{ color-scheme: dark; }
  body{ font-family: Inter, system-ui, Segoe UI, Roboto, sans-serif; }
  .glass{ background: rgba(255,255,255,0.06); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,0.08); }
  .pulse{ animation: pulse 1.4s infinite; } @keyframes pulse{0%{opacity:.7}50%{opacity:1}100%{opacity:.7}}
</style>
</head>
<body class="min-h-screen bg-black text-zinc-100">

<!-- Waiting -->
<section id="waiting" class="fixed inset-0 grid place-items-center"
  style="background: url('assets/backgrounds/lambo_waiting.jpg') center/cover no-repeat;">
  <div class="glass w-full max-w-xl rounded-2xl p-6 border border-white/10">
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-xl font-bold">Lamborghini ‚Äî Sala de espera</h1>
      <span id="roomCounter" class="text-sm text-zinc-300">Jugadores 0/3</span>
    </div>
    <p class="text-sm text-zinc-300 mb-4">Esperando a: <b>Hodely</b>, <b>Logan</b>, <b>Hugo</b>.</p>
    <div id="players" class="grid grid-cols-3 gap-3 mb-4"></div>
    <div class="flex items-center justify-between">
      <div class="text-xs text-zinc-400">El reto empieza cuando est√©n los 3.</div>
      <button id="forceStart" class="hidden px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">Forzar inicio (Admin)</button>
    </div>
  </div>
</section>

<!-- Game -->
<section id="game" class="hidden min-h-screen grid place-items-center">
  <div class="w-full max-w-xl p-6">
    <div class="glass rounded-2xl p-6 border border-white/10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">üèéÔ∏è Lamborghini</h2>
        <div class="text-sm text-zinc-300">Mant√©n pulsado. Suelta = pierdes</div>
      </div>
      <button id="lambo" class="w-full py-8 rounded-2xl bg-yellow-500 text-black font-extrabold text-2xl disabled:opacity-40">MANT√âN PULSADO</button>
      <div class="grid grid-cols-2 gap-3 mt-4 text-sm">
        <div class="glass rounded-xl p-3">
          <div>Mi tiempo</div>
          <div id="myTime" class="text-2xl font-bold">0.000 s</div>
        </div>
        <div class="glass rounded-xl p-3">
          <div>Mejor tiempo</div>
          <div id="bestTime" class="text-2xl font-bold">‚Äî</div>
        </div>
      </div>
    </div>
  </div>
</section>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyCkNI9EEw_4Rf8f4IqygydRTbHSHBAYnKs",
    authDomain: "klex-28ea5.firebaseapp.com",
    databaseURL: "https://klex-28ea5-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "klex-28ea5",
    storageBucket: "klex-28ea5.appspot.com",
    messagingSenderId: "794750673743",
    appId: "1:794750673743:web:8b38291a417089e643db3a",
    measurementId: "G-DQ6E8NBVGR"
  };
  const ADMIN_EMAIL = 'hodelyproductions@gmail.com';

  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const NEEDED = ['hodelyproductions@gmail.com','llopez@jverdaguer.com','harjona@jverdaguer.com'];
  const avatars = {
    'hodelyproductions@gmail.com': 'assets/players/hodely.png',
    'llopez@jverdaguer.com': 'assets/players/logan.png',
    'harjona@jverdaguer.com': 'assets/players/hugo.png'
  };

  const gameId='lambo-room-1';
  const gameRef=doc(db,'games',gameId);
  const playersCol=collection(db,'games',gameId,'players');

  const $=(id)=>document.getElementById(id);
  let ME=null, isAdmin=false, meta={state:'lobby'};

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href='chat.html'; return; }
    ME=user; isAdmin=(user.email?.toLowerCase()===ADMIN_EMAIL);
    $('forceStart').classList.toggle('hidden', !isAdmin);

    await setDoc(doc(playersCol,user.uid),{
      email:user.email.toLowerCase(), name:user.displayName||user.email.split('@')[0], joined:true
    },{merge:true});
    const m=await getDoc(gameRef);
    if(!m.exists()) await setDoc(gameRef,{ state:'lobby' });

    subscribe();
  });

  function subscribe(){
    onSnapshot(gameRef,(snap)=>{ if(snap.exists()){ meta=snap.data(); renderMeta(); }});
    onSnapshot(playersCol,(snap)=>{
      const list=[]; snap.forEach(d=> list.push(d.data()));
      renderWaiting(list);
    });
  }

  function renderWaiting(list){
    const joined = new Set(list.filter(p=>p.joined).map(p=>p.email));
    const count = NEEDED.filter(e=> joined.has(e)).length;
    $('roomCounter').textContent = `Jugadores ${count}/3`;
    $('players').innerHTML = NEEDED.map(e=>{
      const on = joined.has(e);
      const name = e===NEEDED[0]?'Hodely': (e===NEEDED[1]?'Logan':'Hugo');
      const img = avatars[e] || '';
      return `<div class="glass rounded-xl p-3 text-center ${on?'border-emerald-500/40':'border-white/10'}">
        <img src="${img}" class="w-20 h-20 object-cover rounded-xl mx-auto ${on?'':'opacity-40'}">
        <div class="mt-2 text-sm font-medium">${name}</div>
        <div class="text-xs ${on?'text-emerald-300':'text-zinc-400'}">${on?'Conectado':'Esperando‚Ä¶'}</div>
      </div>`;
    }).join('');

    if(count===3 || meta.state!=='lobby'){
      $('waiting').classList.add('hidden'); $('game').classList.remove('hidden');
      $('lambo').disabled = meta.state!=='running';
    } else {
      $('waiting').classList.remove('hidden'); $('game').classList.add('hidden');
    }
  }

  $('forceStart').onclick = ()=> updateDoc(gameRef,{ state:'running' });

  function renderMeta(){
    $('lambo').disabled = meta.state!=='running';
  }

  // juego ‚Äúhold‚Äù
  let holdStart=null, holding=false, best=0;
  const now=()=>performance.now();
  const lambo=$('lambo');

  function startHold(){ if(lambo.disabled) return; holding=true; holdStart=now(); }
  function endHold(){
    if(!holding) return; holding=false;
    const t=(now()-holdStart)/1000;
    $('myTime').textContent=t.toFixed(3)+' s';
    if(t>best){ best=t; $('bestTime').textContent=best.toFixed(3)+' s'; }
  }
  lambo.addEventListener('mousedown',startHold);
  lambo.addEventListener('touchstart',startHold,{passive:true});
  window.addEventListener('mouseup',endHold);
  window.addEventListener('touchend',endHold);
  window.addEventListener('blur',()=>{ if(holding) endHold(); });

</script>
</body>
</html>
